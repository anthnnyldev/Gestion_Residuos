{% extends 'components/base.html' %}
{% load static %}
{% block title %}Gestión de Residuos en {{ country_data.country_name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Encabezado -->
        <header class="bg-white rounded-xl shadow-lg p-6 mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
                Gestión de Residuos en {{ country_data.country_name }}
            </h1>
            <p class="text-gray-600 mt-2">
                Análisis detallado de los datos de residuos y su tratamiento en {{ country_data.country_name }}
            </p>
        </header>

        <!-- Sección de Gráficos -->
        <section class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
            
            <!-- Gráfico: Composición de Residuos (Pastel) -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Composición de Residuos</h2>
                <p class="text-sm text-gray-600 mb-2">Distribución porcentual de tipos de residuos generados en el país.</p>
                <div id="compositionPieChart"></div>
            </div>
            
            <!-- Gráfico: Tratamiento de Residuos (Barras) -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Tratamiento de Residuos</h2>
                <p class="text-sm text-gray-600 mb-2">Porcentaje de residuos tratados mediante diferentes métodos.</p>
                <div id="treatmentBarChart"></div>
            </div>
            
            <!-- Gráfico: Cobertura de Recolección (Barras) -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Cobertura de Recolección</h2>
                <p class="text-sm text-gray-600 mb-2">Cobertura de recolección en zonas rurales y urbanas.</p>
                <div id="collectionCoverageBarChart"></div>
            </div>
            
            <!-- Gráfico: Generación de Residuos Especiales (Barras) -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Generación de Residuos Especiales</h2>
                <p class="text-sm text-gray-600 mb-2">Cantidad de residuos especiales generados anualmente.</p>
                <div id="specialWasteBarChart"></div>
            </div>
        </section>
    </div>
</div>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://d3js.org/d3.v6.min.js"></script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const data = {{ country_data|safe }};
        
        // Gráfico de Pastel: Composición de Residuos
        renderPieChart('#compositionPieChart', [
            { label: 'Orgánicos', value: data.food_waste },
            { label: 'Plástico', value: data.plastic_waste },
            { label: 'Papel', value: data.paper_waste },
            { label: 'Metales', value: data.metal_waste },
        ]);

        // Gráfico de Barras: Tratamiento de Residuos
        renderBarChart('#treatmentBarChart', [
            { label: 'Reciclaje', value: data.waste_treatment_recycling },
            { label: 'Incineración', value: data.waste_treatment_incineration },
            { label: 'Relleno Sanitario', value: data.waste_treatment_landfill },
        ]);

        // Gráfico de Barras: Cobertura de Recolección
        renderBarChart('#collectionCoverageBarChart', [
            { label: 'Rural', value: data.waste_collection_rural },
            { label: 'Urbano', value: data.waste_collection_urban },
        ]);

        // Gráfico de Barras: Generación de Residuos Especiales
        renderBarChart('#specialWasteBarChart', [
            { label: 'Residuos Electrónicos', value: data.special_waste_electronic },
            { label: 'Residuos Industriales', value: data.special_waste_industrial },
            { label: 'Residuos Médicos', value: data.special_waste_medical },
        ]);

        // Función para Gráfico de Pastel
        function renderPieChart(container, data) {
            const width = 200, height = 200, radius = Math.min(width, height) / 2;
            const svg = d3.select(container).append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);
            const color = d3.scaleOrdinal(d3.schemeCategory10);
            const pie = d3.pie().value(d => d.value);
            const arc = d3.arc().innerRadius(0).outerRadius(radius);
            svg.selectAll("path")
                .data(pie(data))
                .enter()
                .append("path")
                .attr("d", arc)
                .attr("fill", d => color(d.data.label));
        }

        // Función para Gráfico de Barras
        function renderBarChart(container, data) {
            const margin = {top: 20, right: 30, bottom: 40, left: 40};
            const width = 200 - margin.left - margin.right;
            const height = 200 - margin.top - margin.bottom;
            const svg = d3.select(container).append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            const x = d3.scaleBand().domain(data.map(d => d.label)).range([0, width]).padding(0.1);
            svg.append("g").call(d3.axisBottom(x)).attr("transform", `translate(0,${height})`);
            const y = d3.scaleLinear().domain([0, d3.max(data, d => d.value)]).nice().range([height, 0]);
            svg.append("g").call(d3.axisLeft(y));
            svg.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.label))
                .attr("y", d => y(d.value))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.value))
                .attr("fill", "#1f77b4");
        }
    });
</script>

<!-- country_detail.html -->
<div id="compositionChart"></div>
<div id="treatmentChart"></div>

<script>
// Cargar datos desde el contexto Django
const countryData = {{ country_data|safe }};

// Gráfico de Pastel para Composición de Residuos
const compositionData = [
    { label: "Orgánicos", value: countryData.food_waste },
    { label: "Plásticos", value: countryData.plastic_waste },
    { label: "Papel", value: countryData.paper_waste },
    { label: "Metales", value: countryData.metal_waste }
];
renderPieChart("#compositionChart", compositionData);

// Gráfico de Barras para Tratamiento de Residuos
const treatmentData = [
    { label: "Reciclaje", value: countryData.waste_treatment_recycling },
    { label: "Incineración", value: countryData.waste_treatment_incineration },
    { label: "Relleno Sanitario", value: countryData.waste_treatment_landfill }
];
renderBarChart("#treatmentChart", treatmentData);

</script>


{% endblock %}
